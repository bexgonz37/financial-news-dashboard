<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NewsPulse — Financial News & Momentum</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121826; --border:#20273a; --text:#e6e8ee; --muted:#9aa3b2;
      --accent:#b167ff; --accent-2:#8f6cff; --up:#24e39c; --down:#ff5b6e; --chip:#1a2132;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text); }
    a{ color:var(--accent) }
    .container{ max-width:1200px; margin:0 auto; padding:20px; }

    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap }
    .brand{ font-weight:900; letter-spacing:.2px; }
    .rightTop{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:flex-end }
    .clock{ color:var(--muted); font-size:.95rem }
    .session{ border:1px solid var(--border); padding:4px 8px; border-radius:999px; color:var(--muted); font-size:.8rem }
    .session.live{ color:var(--text); border-color:var(--accent) }

    .donateCta{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:.9rem }
    .donateCta strong{ color:#fff }
    .donateBar{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-pill{
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#fff; border:1px solid rgba(255,255,255,.12);
      padding:8px 12px; border-radius:999px; font-weight:800; cursor:pointer; font-size:.9rem;
    }

    .disclaimer{
      background:linear-gradient(180deg, rgba(177,103,255,.15), rgba(177,103,255,.06));
      border:1px solid var(--border);
      color:var(--text);
      padding:14px 16px; border-radius:12px; margin-bottom:18px; line-height:1.5;
    }
    .disclaimer strong{ color:var(--accent); }

    .tabs{ display:flex; gap:10px; margin:12px 0 18px; flex-wrap:wrap }
    .tab{ border:1px solid var(--border); background:var(--card); color:var(--text); padding:10px 16px; border-radius:999px; cursor:pointer; }
    .tab.active{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(177,103,255,.15) inset }

    .panel{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px }
    .input, .select, .btn{
      background:var(--card); color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:10px; outline:none;
    }
    .btn{ cursor:pointer; }
    .meta{ color:var(--muted); font-size:.85rem }

    /* Filters popover */
    .filter-chip{ display:flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--chip); cursor:pointer }
    .popover{ position:relative; display:inline-block }
    .popover-panel{
      position:absolute; top:110%; left:0; z-index:20; min-width:260px;
      background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:none;
    }
    .popover.open .popover-panel{ display:block }
    .checks{ display:grid; grid-template-columns:1fr 1fr; gap:6px 12px; margin:6px 0 10px }
    .checks label{ display:flex; gap:8px; align-items:center; color:var(--text); font-size:.9rem }

    .news-list{ display:grid; gap:12px; }
    .news-item{ border:1px solid var(--border); border-radius:12px; padding:12px; background:linear-gradient(180deg, rgba(32,39,58,.6), rgba(18,24,38,.9)); }
    .item-top{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .ticker{ background:rgba(177,103,255,.16); border:1px solid var(--accent); color:#fff; padding:4px 10px; border-radius:999px; font-weight:700; cursor:pointer; text-decoration:none }
    .star{ background:none; border:1px solid var(--border); color:var(--muted); border-radius:8px; padding:4px 8px; cursor:pointer }
    .star.active{ color:#ffd84e; border-color:#ffd84e }
    .pct{ font-weight:700 } .pct.up{ color:var(--up) } .pct.down{ color:var(--down) }
    .title{ margin-top:8px; font-weight:800; color:#fff }
    .summary{ color:var(--muted); margin-top:6px; line-height:1.5 }
    .mini-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:8px; flex-wrap:wrap }
    .mini-chart{ width:220px; height:60px }
    .src{ color:var(--muted); font-size:.85rem }

    /* Scanner */
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px }
    .kpi{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap }
    .change.up{ color:var(--up); font-weight:800 } .change.down{ color:var(--down); font-weight:800 }

    /* Watchlist */
    .wl-row{ display:flex; align-items:center; gap:12px; justify-content:space-between; border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:10px; background:rgba(32,39,58,.6) }
    .wl-tools{ display:flex; align-items:center; gap:8px }

    .loading{ text-align:center; color:var(--muted); padding:28px }

    @media (max-width:900px){
      .rightTop{ justify-content:flex-start }
    }
    @media (max-width:700px){
      .mini-row{ flex-direction:column; align-items:flex-start }
      .mini-chart{ width:100%; height:56px }
      .donateCta{ display:none }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top -->
    <div class="topbar">
      <div class="brand">NewsPulse</div>
      <div class="rightTop">
        <div class="donateCta">Please consider <strong>donating</strong> so we can add paid data & grow this into a full app.</div>
        <div class="donateBar">
          <button class="btn-pill" id="donate-once">Donate Once</button>
          <button class="btn-pill" id="donate-monthly">Donate Monthly</button>
          <button class="btn-pill" id="manage-subscription">Manage Subscription</button>
        </div>
        <div class="clock" id="etClock">—:— ET</div>
        <div class="session" id="sessionBadge">Session: —</div>
      </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer">
      <strong>Educational Purposes Only.</strong> The content on this site (including news, data, and any analysis) is provided for informational and educational purposes only and does not constitute investment, financial, or trading advice. Nothing on this website is a recommendation or endorsement to buy or sell any security. Market data may be delayed, inaccurate, or incomplete. Trading involves substantial risk, including the risk of loss. You are solely responsible for your trading decisions. Consider consulting a licensed financial professional. We make no warranties and assume no liability for any losses arising from use of this site.
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="news">News</button>
      <button class="tab" data-tab="scanners">Scanners</button>
      <button class="tab" data-tab="watchlist">Watchlist</button>
    </div>

    <!-- NEWS -->
    <div id="view-news" class="panel">
      <div class="toolbar">
        <!-- Filters popover (multi-select) -->
        <div class="popover" id="filtersPopover">
          <button class="filter-chip" id="filtersBtn">Filters <span class="meta" id="filtersCount">(All)</span></button>
          <div class="popover-panel">
            <div class="checks" id="catChecks">
              <!-- injected by JS -->
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end">
              <button class="btn" id="filtersClear">Clear</button>
              <button class="btn" id="filtersApply" style="background:var(--accent);border:1px solid rgba(255,255,255,.12);color:#fff">Apply</button>
            </div>
          </div>
        </div>

        <input class="input" id="ticker" placeholder="Ticker (optional)" />
        <input class="input" id="keyword" placeholder="Keyword (optional)" />
        <button class="btn" id="run">Search</button>
        <button class="btn" id="manualRefresh" title="Refresh now">Refresh</button>
        <label class="meta" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="autoRefresh" checked />
          Auto (60s)
        </label>
        <!-- Optional metrics toggles -->
        <label class="meta" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="showPct" checked />
          Show % change
        </label>
        <label class="meta" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="showRVOL" />
          Show RVOL
        </label>
      </div>

      <div id="news-feed" class="news-list">
        <div class="loading">Loading financial news…</div>
      </div>
    </div>

    <!-- SCANNERS -->
    <div id="view-scanners" class="panel" style="display:none">
      <div class="toolbar">
        <select class="select" id="scannerPreset">
          <option value="momentum">High Momentum</option>
          <option value="big_movers">Biggest % Movers</option>
          <option value="rvol">High Relative Volume</option>
        </select>
        <input class="input" id="minPct" type="number" step="0.1" placeholder="Min % (e.g. 2)"/>
        <input class="input" id="minRVOL" type="number" step="0.1" placeholder="Min RVOL (e.g. 1.5)"/>
        <input class="input" id="minMentions" type="number" step="1" placeholder="Min mentions (e.g. 2)"/>
        <button class="btn" id="rescore">Recalculate</button>
        <!-- Optional metrics toggles -->
        <label class="meta" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="scanShowRVOL" />
          Show RVOL
        </label>
        <label class="meta" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="scanShowMentions" />
          Show Mentions
        </label>
        <label class="meta" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="scanShowChart" checked />
          Show mini chart
        </label>
      </div>
      <div id="scanner-grid" class="grid">
        <div class="card">Run a news load, then click Recalculate to see high-momentum movers.</div>
      </div>
    </div>

    <!-- WATCHLIST -->
    <div id="view-watchlist" class="panel" style="display:none">
      <div class="toolbar">
        <input class="input" id="wlAdd" placeholder="Add ticker (e.g., NVDA)"/>
        <button class="btn" id="wlAddBtn">Add</button>
      </div>
      <div id="wlList"></div>
    </div>
  </div>

  <!-- Chart Modal -->
  <div id="chartModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:rgba(0,0,0,.55); padding:20px">
    <div class="modal" style="width:min(920px,95vw); height:min(600px,85vh); background:var(--card); border:1px solid var(--border); border-radius:14px; display:flex; flex-direction:column;">
      <div class="modal-head" style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border)">
        <div class="modal-title" id="chartTitle" style="font-weight:900">Chart</div>
        <div class="modal-tools" style="display:flex; align-items:center; gap:8px">
          <span class="meta">Indicators:</span>
          <label><input type="checkbox" class="ind" value="vwap" checked /> VWAP</label>
          <label><input type="checkbox" class="ind" value="sma20" /> SMA 20</label>
          <label><input type="checkbox" class="ind" value="ema9" /> EMA 9</label>
          <label><input type="checkbox" class="ind" value="rsi14" /> RSI 14</label>
          <button class="btn" onclick="closeChart()">Close</button>
        </div>
      </div>
      <div id="chartBody" class="modal-body" style="flex:1"></div>
    </div>
  </div>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    // ---------- CONSTANTS ----------
    const CATEGORIES = [
      ['medical','Medical / FDA'], ['patent','Patent / IP'], ['lawsuit','Lawsuit / Legal'],
      ['acquisition','Acquisition / M&A'], ['earnings','Earnings'], ['offering','Public Offering'],
      ['guidance','Guidance'], ['upgrade','Analyst Upgrade'], ['downgrade','Analyst Downgrade'],
      ['partnership','Partnership'], ['product','Product Launch'], ['sec','SEC Filing'], ['insider','Insider Activity']
    ];
    const RETAIN_DAYS = 7;

    // ---------- STATE ----------
    let allNewsStore = new Map();  // id -> article
    let newsData = [];             // sorted derived
    let filteredNews = [];
    const stockCache = new Map();  // ticker -> { changePercent, change, ts }
    let selectedCats = new Set();  // multi-select categories
    let watchlist = new Set();

    // optional metrics toggles (defaults)
    let optShowPct = true;
    let optShowRVOL = false;
    let scanOptShowRVOL = false;
    let scanOptShowMentions = false;
    let scanOptShowChart = true;

    // ---------- CLOCK + SESSION ----------
    const etFmt = new Intl.DateTimeFormat('en-US',{ timeZone:'America/New_York', hour:'2-digit', minute:'2-digit' });
    function updateClockAndSession(){
      const now = new Date();
      document.getElementById('etClock').textContent = etFmt.format(now) + ' ET';
      const d = new Date().toLocaleString('en-US', { timeZone: 'America/New_York' });
      const n = new Date(d); const day=n.getDay(); const hh=n.getHours(), mm=n.getMinutes(); const mins=hh*60+mm;
      let label='Closed', live=false;
      if(day>=1 && day<=5){
        if(mins<570 && mins>=240) label='Premarket';
        else if(mins>=570 && mins<=960){ label='Regular Hours'; live=true; }
        else if(mins>960 && mins<=1200) label='After-hours';
      }
      const b=document.getElementById('sessionBadge'); b.textContent=`Session: ${label}`; b.className='session'+(live?' live':'');
    }
    setInterval(updateClockAndSession, 15000); updateClockAndSession();

    // ---------- PERSIST ----------
    (function loadStore(){
      try {
        const raw = localStorage.getItem('newsStoreV1');
        const keptUntil = Date.now() - RETAIN_DAYS*24*3600*1000;
        if (raw) {
          const arr = JSON.parse(raw);
          for (const a of arr) {
            const t = Date.parse(a.publishedAt||0);
            if (!t || t < keptUntil) continue;
            allNewsStore.set(a.id, a);
          }
        }
      } catch {}
      try {
        const wl = JSON.parse(localStorage.getItem('watchlistV1')||'[]');
        for(const t of wl) watchlist.add(String(t).toUpperCase());
      } catch {}
      try {
        const prefs = JSON.parse(localStorage.getItem('metricPrefsV1')||'{}');
        optShowPct = prefs.newsPct ?? true;
        optShowRVOL = prefs.newsRVOL ?? false;
        scanOptShowRVOL = prefs.scanRVOL ?? false;
        scanOptShowMentions = prefs.scanMentions ?? false;
        scanOptShowChart = prefs.scanChart ?? true;
      } catch {}
    })();
    function persistStore(){
      try { localStorage.setItem('newsStoreV1', JSON.stringify(Array.from(allNewsStore.values()))); } catch {}
    }
    function persistWatchlist(){
      try { localStorage.setItem('watchlistV1', JSON.stringify(Array.from(watchlist.values()))); } catch {}
    }
    function persistMetricPrefs(){
      try {
        localStorage.setItem('metricPrefsV1', JSON.stringify({
          newsPct: optShowPct, newsRVOL: optShowRVOL,
          scanRVOL: scanOptShowRVOL, scanMentions: scanOptShowMentions, scanChart: scanOptShowChart
        }));
      } catch {}
    }

    // ---------- HELPERS ----------
    function mergeNews(newItems){
      let added=0;
      for(const a of (newItems||[])){
        if(!a || !a.id) continue;
        if(!allNewsStore.has(a.id)){ allNewsStore.set(a.id, a); added++; }
        else allNewsStore.set(a.id, { ...allNewsStore.get(a.id), ...a });
      }
      if (added) persistStore();
      return added;
    }
    function currentNewsArray(){
      const arr = Array.from(allNewsStore.values());
      arr.sort((a,b)=> (Date.parse(b.publishedAt||0) - Date.parse(a.publishedAt||0)));
      return arr;
    }
    function timeAgo(iso){
      const t = Date.parse(iso||''); if(!t) return '';
      const s = Math.floor((Date.now()-t)/1000);
      if (s<60) return `${s}s ago`;
      const m = Math.floor(s/60); if(m<60) return `${m}m ago`;
      const h = Math.floor(m/60); if(h<24) return `${h}h ago`;
      const d = Math.floor(h/24); return `${d}d ago`;
    }

    async function getQuote(ticker){
      const key = ticker.toUpperCase();
      const cached = stockCache.get(key);
      if(cached && (Date.now()-cached.ts)<60_000) return cached;
      const r = await fetch(`/api/data?ticker=${encodeURIComponent(key)}`);
      if(!r.ok) return null;
      const payload = await r.json();
      const q = payload?.data?.stock;
      if(!q) return null;
      const obj = { changePercent:q.changePercent, change:q.change, ts:Date.now() };
      stockCache.set(key, obj); return obj;
    }
    async function getRVOL(ticker){
      const r = await fetch(`/api/data?ticker=${encodeURIComponent(ticker)}`);
      if(!r.ok) return null;
      const payload = await r.json();
      const m = payload?.data?.market;
      if(!m || !m.volume || !m.avgVolume) return null;
      return m.volume / m.avgVolume;
    }

    async function drawSparkline(el, ticker){
      try{
        let r = await fetch(`/api/ohlc?ticker=${encodeURIComponent(ticker)}&interval=1min&limit=180&last=1`);
        if (!r.ok) throw new Error('last session fetch failed');
        let payload = await r.json();
        let candles = payload.candles || [];
        if (candles.length < 2) {
          r = await fetch(`/api/ohlc?ticker=${encodeURIComponent(ticker)}&interval=1min&limit=180`);
          payload = await r.json();
          candles = payload.candles || [];
        }
        const closes = candles.map(c=>c.c);
        if(closes.length<2){ el.innerHTML=''; return; }
        const w=el.clientWidth||220, h=el.clientHeight||60, pad=5;
        const min=Math.min(...closes), max=Math.max(...closes);
        const xStep=(w-2*pad)/(closes.length-1);
        const y=v=> h-pad-((v-min)/(max-min||1))*(h-2*pad);
        let d=''; closes.forEach((v,i)=>{ const x=pad+i+xStep; const yy=y(v); d+=(i?`L${x},${yy}`:`M${x},${yy}`); });
        const color = closes[closes.length-1]>=closes[0] ? '#24e39c' : '#ff5b6e';
        el.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><path d="${d}" fill="none" stroke="${color}" stroke-width="2"/></svg>`;
      }catch{ el.innerHTML=''; }
    }

    // ---------- FILTER UI ----------
    function renderFilterChecks(){
      const wrap = document.getElementById('catChecks');
      wrap.innerHTML = CATEGORIES.map(([val,label])=>{
        const checked = selectedCats.has(val) ? 'checked' : '';
        return `<label><input type="checkbox" value="${val}" ${checked}/> ${label}</label>`;
      }).join('');
      updateFiltersCount();
    }
    function updateFiltersCount(){
      const span = document.getElementById('filtersCount');
      if(!selectedCats.size) span.textContent = '(All)';
      else span.textContent = `(${selectedCats.size} selected)`;
    }
    function closeAllPopovers(e){
      if(!e) return;
      const pop = document.getElementById('filtersPopover');
      if (!pop.contains(e.target)) pop.classList.remove('open');
    }
    document.addEventListener('click', closeAllPopovers);

    // ---------- FETCH + APPLY ----------
    async function fetchData(){
      const params = new URLSearchParams();
      const t = (document.getElementById('ticker').value||'').trim();
      const k = (document.getElementById('keyword').value||'').trim();
      if (t) params.set('ticker', t.toUpperCase());
      if (k) params.set('search', k);

      try{
        const r = await fetch(`/api/data?${params.toString()}`);
        if(!r.ok) throw new Error('API error');
        const data = await r.json();
        const incoming = data?.data?.news || [];
        mergeNews(incoming);
        newsData = currentNewsArray();
        applyFilter();
      }catch(e){
        console.error(e);
        newsData = currentNewsArray();
        applyFilter();
      }
    }

    function applyFilter(){
      const k = (document.getElementById('keyword').value||'').toLowerCase();
      const multipleCats = Array.from(selectedCats.values());
      filteredNews = newsData.filter(n=>{
        const cat = (n.category||'').toLowerCase();
        const byCat = !multipleCats.length || multipleCats.includes(cat) ||
          multipleCats.some(c => (n.title||'').toLowerCase().includes(c) || (n.summary||'').toLowerCase().includes(c));
        const byKey = !k || ( (n.title||'').toLowerCase().includes(k) || (n.summary||'').toLowerCase().includes(k) );
        return byCat && byKey;
      });
      renderNews();
    }

    // ---------- RENDER NEWS (eager) ----------
    function renderNews(){
      const feed = document.getElementById('news-feed');
      if (!filteredNews.length){
        feed.innerHTML = `<div class="loading">No news found for the selected filters.</div>`;
        return;
      }
      feed.innerHTML = filteredNews.map(n=>{
        const t = (n.ticker||'').toUpperCase();
        const when = n.publishedAt ? timeAgo(n.publishedAt) : '';
        const source = n.source ? n.source : '';
        const starred = watchlist.has(t) ? 'active' : '';
        // optional metrics nodes (shown/hidden later)
        const pctNode = `<span class="pct" data-optional="pct"><span class="arrow">⏳</span> <span class="val">…</span></span>`;
        const rvolNode = `<span class="meta rvol" data-optional="rvol"></span>`;
        return `
          <div class="news-item">
            <div class="item-top">
              <a class="ticker" href="#" data-open-chart="${t}">${t || 'GENERAL'}</a>
              ${pctNode}
              ${rvolNode}
              <span class="src">${source ? source : ''}${when ? ` · ${when}` : ''}</span>
              <button class="star ${starred}" data-star="${t}">${starred?'★':'☆'}</button>
            </div>
            <div class="title">${n.title||''}</div>
            <div class="summary">${n.summary||''} ${n.url?`<a href="${n.url}" target="_blank" rel="noopener">Read</a>`:''}</div>
            <div class="mini-row">
              <div class="meta">${n.category ? n.category : ''}</div>
              <div class="mini-chart" data-ticker="${t}"></div>
            </div>
          </div>
        `;
      }).join('');

      // show/hide optional metrics
      document.querySelectorAll('[data-optional="pct"]').forEach(n=> n.style.display = optShowPct ? '' : 'none');
      document.querySelectorAll('[data-optional="rvol"]').forEach(n=> n.style.display = optShowRVOL ? '' : 'none');

      // hydrate each card
      const cards = feed.querySelectorAll('.news-item');
      cards.forEach(async (card)=>{
        const t = (card.querySelector('.mini-chart')?.dataset?.ticker||'').toUpperCase();
        if(!t || t==='GENERAL') return;

        // % change
        if (optShowPct){
          try{
            const q = await getQuote(t);
            if(q && typeof q.changePercent==='number'){
              const val = card.querySelector('.val');
              const arrow = card.querySelector('.arrow');
              if (val){ val.textContent = `${q.changePercent>0?'+':''}${q.changePercent.toFixed(2)}%`; val.className = 'val ' + (q.changePercent>0?'up':'down'); }
              if (arrow) arrow.textContent = q.changePercent>0 ? '↗' : '↘';
            }
          }catch{}
        }

        // RVOL
        if (optShowRVOL){
          try{
            const rv = await getRVOL(t);
            if (rv){
              const node = card.querySelector('.rvol');
              if (node) node.textContent = `RVOL ${rv.toFixed(2)}x`;
            }
          }catch{}
        }

        // sparkline
        drawSparkline(card.querySelector('.mini-chart'), t);
      });
    }

    // ---------- SCANNER ----------
    async function buildScanners(){
      const base = filteredNews.length ? filteredNews : newsData;
      const stats = new Map(); // ticker -> {mentions, latest}
      for(const n of base){
        const t = (n.ticker||'').toUpperCase(); if(!t || t==='GENERAL') continue;
        const s = stats.get(t)||{mentions:0,latest:0}; s.mentions++;
        const ts = n.publishedAt?Date.parse(n.publishedAt):0; if(ts> (s.latest||0)) s.latest = ts;
        stats.set(t,s);
      }
      const list = [...stats.keys()].slice(0,80);
      const rows = [];
      for(const t of list){
        let pct=0, rvol=0, rec=0;
        try{ const q=await getQuote(t); pct = q?.changePercent||0; }catch{}
        try{ const rv=await getRVOL(t); rvol = rv||0; }catch{}
        const minsOld = stats.get(t)?.latest ? (Date.now()-stats.get(t).latest)/60000 : 999;
        rec = Math.max(0, 30 - Math.min(30, minsOld)); // 0..30 recent boost
        const score = (pct*1.0) + (stats.get(t).mentions*0.6) + (rvol*5) + (rec*0.35);
        rows.push({ ticker:t, pct, mentions:stats.get(t).mentions, rvol, recency:rec, score });
      }

      // presets
      const preset = document.getElementById('scannerPreset').value;
      if (preset==='big_movers') rows.sort((a,b)=> Math.abs(b.pct)-Math.abs(a.pct));
      else if (preset==='rvol') rows.sort((a,b)=> b.rvol-a.rvol);
      else rows.sort((a,b)=> b.score-a.score);

      const minPct = parseFloat(document.getElementById('minPct').value||'NaN');
      const minRVOL = parseFloat(document.getElementById('minRVOL').value||'NaN');
      const minMent = parseFloat(document.getElementById('minMentions').value||'NaN');
      const filt = rows.filter(r=>{
        return (isNaN(minPct) || Math.abs(r.pct)>=minPct) &&
               (isNaN(minRVOL) || r.rvol>=minRVOL) &&
               (isNaN(minMent) || r.mentions>=minMent);
      }).slice(0,18);

      const grid = document.getElementById('scanner-grid');
      if(!filt.length){ grid.innerHTML = `<div class="card">No results match the thresholds.</div>`; return; }

      grid.innerHTML = filt.map(r=>{
        const rvolHtml = scanOptShowRVOL ? ` · RVOL: ${r.rvol?r.rvol.toFixed(2):'—'}` : '';
        const mentHtml = scanOptShowMentions ? ` · Mentions: ${r.mentions}` : '';
        return `
          <div class="card">
            <div class="kpi">
              <div>
                <div style="font-weight:900">${r.ticker}</div>
                <div class="meta">Recency: ${r.recency.toFixed(0)}${rvolHtml}${mentHtml}</div>
              </div>
              <div class="change ${r.pct>=0?'up':'down'}">${r.pct>=0?'↗':'↘'} ${r.pct.toFixed(2)}%</div>
            </div>
            ${scanOptShowChart ? `<div class="mini-chart" data-ticker="${r.ticker}" style="margin-top:8px"></div>` : ``}
            <div class="meta" style="margin-top:6px">
              <a href="#" data-open-chart="${r.ticker}">Open chart</a>
              <button class="star ${watchlist.has(r.ticker)?'active':''}" data-star="${r.ticker}" style="margin-left:8px">${watchlist.has(r.ticker)?'★':'☆'}</button>
            </div>
          </div>
        `;
      }).join('');

      // draw charts if enabled
      if (scanOptShowChart){
        grid.querySelectorAll('.mini-chart').forEach(slot=>{
          const t = slot.getAttribute('data-ticker');
          if (t) drawSparkline(slot, t);
        });
      }
    }

    // ---------- WATCHLIST ----------
    function toggleWatchlist(t){
      const key = String(t||'').toUpperCase();
      if(!key) return;
      if(watchlist.has(key)) watchlist.delete(key); else watchlist.add(key);
      persistWatchlist();
      document.querySelectorAll(`[data-star="${key}"]`).forEach(btn=>{
        const on = watchlist.has(key);
        btn.classList.toggle('active', on);
        btn.textContent = on ? '★' : '☆';
      });
      renderWatchlist();
    }
    function renderWatchlist(){
      const wrap = document.getElementById('wlList');
      const list = Array.from(watchlist.values()).sort();
      if (!list.length){ wrap.innerHTML = `<div class="loading">No tickers yet. Star items from News or add tickers above.</div>`; return; }
      wrap.innerHTML = list.map(t=>`
        <div class="wl-row">
          <div>
            <div style="font-weight:900">${t}</div>
            <div class="meta pct" data-wl-pct="${t}">—</div>
          </div>
          <div class="mini-chart" data-ticker="${t}"></div>
          <div class="wl-tools">
            <a href="#" data-open-chart="${t}">Chart</a>
            <button class="btn" data-remove="${t}">Remove</button>
          </div>
        </div>
      `).join('');
      wrap.querySelectorAll('.wl-row').forEach(async row=>{
        const t = row.querySelector('.mini-chart').dataset.ticker;
        drawSparkline(row.querySelector('.mini-chart'), t);
        try{
          const q = await getQuote(t);
          const node = row.querySelector(`[data-wl-pct="${t}"]`);
          if (q && node){
            node.textContent = `${q.changePercent>=0?'+':''}${q.changePercent.toFixed(2)}%`;
            node.classList.toggle('up', q.changePercent>=0);
            node.classList.toggle('down', q.changePercent<0);
          }
        }catch{}
      });
    }

    // ---------- CHART MODAL ----------
    function sma(data, period){
      const out=[]; let sum=0;
      for(let i=0;i<data.length;i++){ sum+=data[i].close; if(i>=period) sum-=data[i-period].close; if(i>=period-1) out.push({time:data[i].time,value:sum/period}); }
      return out;
    }
    function ema(data, period){
      const out=[]; const k=2/(period+1); let prev=data[0]?.close||0;
      out.push({time:data[0]?.time,value:prev});
      for(let i=1;i<data.length;i++){ const v=data[i].close*k + prev*(1-k); out.push({time:data[i].time,value:v}); prev=v; }
      return out;
    }
    function rsi(data, period){
      const out=[]; let g=0,l=0;
      for(let i=1;i<=period;i++){ const ch=data[i].close - data[i-1].close; if(ch>=0) g+=ch; else l-=ch; }
      let avgG=g/period, avgL=l/period; let rs=avgL===0?100:avgG/avgL;
      out.push({time:data[period].time,value:100-100/(1+rs)});
      for(let i=period+1;i<data.length;i++){
        const ch=data[i].close - data[i-1].close; const gg=Math.max(0,ch), ll=Math.max(0,-ch);
        avgG=(avgG*(period-1)+gg)/period; avgL=(avgL*(period-1)+ll)/period; rs=avgL===0?100:avgG/avgL;
        out.push({time:data[i].time,value:100-100/(1+rs)});
      }
      return out;
    }

    function getIndPrefs(){
      try { return JSON.parse(localStorage.getItem('indPrefsV1')||'{}'); } catch { return {}; }
    }
    function setIndPrefs(obj){
      try { localStorage.setItem('indPrefsV1', JSON.stringify(obj||{})); } catch {}
    }

    async function openChart(ticker){
      const modal = document.getElementById('chartModal');
      const body = document.getElementById('chartBody');
      const title = document.getElementById('chartTitle');
      title.textContent = `${ticker} — intraday (1m)`;
      body.innerHTML = '';

      const r = await fetch(`/api/ohlc?ticker=${encodeURIComponent(ticker)}&interval=1min&limit=300&last=1`);
      const payload = await r.json();
      const candles = payload.candles||[];
      const data = candles.map(k=>({ time:Math.floor(new Date(k.t).getTime()/1000), open:k.o, high:k.h, low:k.l, close:k.c, volume:k.v }));

      const container = document.createElement('div'); container.style.width='100%'; container.style.height='100%'; body.appendChild(container);
      const chart = LightweightCharts.createChart(container, {
        layout:{ background:{type:'Solid', color:'#0b0f17'}, textColor:'#e6e8ee' },
        grid:{ vertLines:{color:'#1a2132'}, horzLines:{color:'#1a2132'} },
        rightPriceScale:{ borderColor:'#20273a' }, timeScale:{ borderColor:'#20273a' }, autoSize:true
      });
      const candleSeries = chart.addCandlestickSeries({
        upColor:'#24e39c', downColor:'#ff5b6e', borderUpColor:'#24e39c', borderDownColor:'#ff5b6e', wickUpColor:'#24e39c', wickDownColor:'#ff5b6e'
      });
      candleSeries.setData(data);

      const volSeries = chart.addHistogramSeries({ priceFormat:{type:'volume'}, priceScaleId:'', base:0 });
      volSeries.setData(data.map(k=>({ time:k.time, value:k.volume, color: k.close>=k.open?'#24e39c':'#ff5b6e' })));
      chart.priceScale('').applyOptions({ scaleMargins:{ top:0.8, bottom:0 } });

      let vwap=null,sma20=null,ema9=null,rsiPane=null;
      const checks = Array.from(document.querySelectorAll('.modal .ind'));
      const pref = getIndPrefs(); checks.forEach(ch=> ch.checked = !!pref[ch.value] || ch.checked);

      function renderIndicators(){
        const chosen = new Set(checks.filter(c=>c.checked).map(c=>c.value));
        setIndPrefs(Object.fromEntries([...chosen].map(k=>[k,true])));
        if(chosen.has('vwap')){
          if(!vwap) vwap = chart.addLineSeries({ color:'#b167ff', lineWidth:2 });
          let cumPV=0,cumV=0;
          const v = data.map(k=>{ const typ=(k.high+k.low+k.close)/3; cumPV+=typ*(k.volume||0); cumV+=(k.volume||0)||1; return {time:k.time,value:cumPV/cumV}; });
          vwap.setData(v);
        } else if(vwap){ vwap.setData([]); }
        if(chosen.has('sma20')){ if(!sma20) sma20=chart.addLineSeries({color:'#8f6cff',lineWidth:2}); sma20.setData(sma(data,20)); }
        else if(sma20){ sma20.setData([]); }
        if(chosen.has('ema9')){ if(!ema9) ema9=chart.addLineSeries({color:'#c08bff',lineWidth:2}); ema9.setData(ema(data,9)); }
        else if(ema9){ ema9.setData([]); }
        if(chosen.has('rsi14')){
          if(!rsiPane){ rsiPane=chart.addLineSeries({ color:'#b167ff', lineWidth:2, priceScaleId:'rsi' }); chart.priceScale('rsi').applyOptions({ scaleMargins:{ top:0.02, bottom:0.65 } }); }
          rsiPane.setData(rsi(data,14));
        } else if(rsiPane){ rsiPane.setData([]); }
      }
      checks.forEach(ch => ch.addEventListener('change', renderIndicators));
      renderIndicators();

      try{ const q=await getQuote(ticker); if(q && typeof q.changePercent==='number'){ title.textContent += ` • ${q.changePercent>0?'↗':'↘'} ${q.changePercent.toFixed(2)}%`; } }catch{}
      modal.style.display='flex';
    }
    function closeChart(){ document.getElementById('chartModal').style.display='none'; }

    // ---------- STRIPE (front-end triggers) ----------
    async function postJSON(url, body){
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
      if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json();
    }
    document.getElementById('donate-once').addEventListener('click', async ()=>{
      try{ const { url } = await postJSON('/api/checkout', { mode:'payment' }); if(url) window.location.href = url; }catch(e){ alert('Unable to start checkout.'); }
    });
    document.getElementById('donate-monthly').addEventListener('click', async ()=>{
      try{ const { url } = await postJSON('/api/checkout', { mode:'subscription' }); if(url) window.location.href = url; }catch(e){ alert('Unable to start checkout.'); }
    });
    document.getElementById('manage-subscription').addEventListener('click', async ()=>{
      try{ const { url } = await postJSON('/api/portal', {}); if(url) window.location.href = url; }catch(e){ alert('Unable to open portal.'); }
    });

    // ---------- EVENTS ----------
    document.addEventListener('click', (e)=>{
      // tabs
      const tab = e.target.closest('.tab');
      if(tab){
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        tab.classList.add('active');
        const v = tab.dataset.tab;
        document.getElementById('view-news').style.display = (v==='news')?'block':'none';
        document.getElementById('view-scanners').style.display = (v==='scanners')?'block':'none';
        document.getElementById('view-watchlist').style.display = (v==='watchlist')?'block':'none';
        if (v==='scanners') buildScanners();
        if (v==='watchlist') renderWatchlist();
      }
      // chart open
      const chartLink = e.target.closest('[data-open-chart]');
      if(chartLink){ e.preventDefault(); const t = chartLink.getAttribute('data-open-chart'); if(t && t!=='GENERAL') openChart(t); }
      // star/watchlist toggle
      const star = e.target.closest('[data-star]');
      if (star){ const t=star.getAttribute('data-star'); toggleWatchlist(t); }
      // remove from watchlist
      const rem = e.target.closest('[data-remove]');
      if(rem){ const t=rem.getAttribute('data-remove'); watchlist.delete(t); persistWatchlist(); renderWatchlist(); document.querySelectorAll(`[data-star="${t}"]`).forEach(btn=>{ btn.classList.remove('active'); btn.textContent='☆'; }); }
      // filters popover toggle
      if (e.target.id==='filtersBtn' || e.target.closest('#filtersBtn')){
        document.getElementById('filtersPopover').classList.toggle('open');
      }
    });

    // filters logic
    document.getElementById('filtersClear').addEventListener('click', ()=>{
      selectedCats.clear(); renderFilterChecks();
    });
    document.getElementById('filtersApply').addEventListener('click', ()=>{
      document.getElementById('filtersPopover').classList.remove('open'); applyFilter();
    });
    document.getElementById('run').addEventListener('click', ()=>fetchData());
    document.getElementById('manualRefresh').addEventListener('click', ()=>fetchData());

    // optional metrics toggles hook-up
    const showPctBox = document.getElementById('showPct');
    const showRVOLBox = document.getElementById('showRVOL');
    const scanShowRVOLBox = document.getElementById('scanShowRVOL');
    const scanShowMentionsBox = document.getElementById('scanShowMentions');
    const scanShowChartBox = document.getElementById('scanShowChart');

    showPctBox.checked = optShowPct;
    showRVOLBox.checked = optShowRVOL;
    scanShowRVOLBox.checked = scanOptShowRVOL;
    scanShowMentionsBox.checked = scanOptShowMentions;
    scanShowChartBox.checked = scanOptShowChart;

    showPctBox.addEventListener('change', ()=>{ optShowPct = showPctBox.checked; persistMetricPrefs(); renderNews(); });
    showRVOLBox.addEventListener('change', ()=>{ optShowRVOL = showRVOLBox.checked; persistMetricPrefs(); renderNews(); });
    scanShowRVOLBox.addEventListener('change', ()=>{ scanOptShowRVOL = scanShowRVOLBox.checked; persistMetricPrefs(); buildScanners(); });
    scanShowMentionsBox.addEventListener('change', ()=>{ scanOptShowMentions = scanShowMentionsBox.checked; persistMetricPrefs(); buildScanners(); });
    scanShowChartBox.addEventListener('change', ()=>{ scanOptShowChart = scanShowChartBox.checked; persistMetricPrefs(); buildScanners(); });

    // auto refresh
    let autoTimer = null;
    function setAutoRefresh(on){
      if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
      if (on) autoTimer = setInterval(()=>fetchData(), 60000);
    }
    const autoBox = document.getElementById('autoRefresh');
    autoBox.addEventListener('change', ()=> setAutoRefresh(autoBox.checked));
    setAutoRefresh(autoBox.checked);

    // scanner controls
    document.getElementById('rescore').addEventListener('click', buildScanners);

    // watchlist controls
    document.getElementById('wlAddBtn').addEventListener('click', ()=>{
      const v = (document.getElementById('wlAdd').value||'').trim().toUpperCase();
      if(!v) return; watchlist.add(v); persistWatchlist(); renderWatchlist(); document.getElementById('wlAdd').value='';
    });

    // init filters UI
    function initFiltersUI(){
      renderFilterChecks();
      document.getElementById('catChecks').addEventListener('change', (e)=>{
        if(e.target && e.target.type==='checkbox'){
          const v = e.target.value;
          if(e.target.checked) selectedCats.add(v); else selectedCats.delete(v);
          updateFiltersCount();
        }
      });
    }

    // ---------- INIT ----------
    async function init(){
      initFiltersUI();
      document.getElementById('news-feed').innerHTML = `<div class="loading">Fetching live financial news…</div>`;
      await fetchData();
      buildScanners();
    }
    init();
  </script>
</body>
</html>
