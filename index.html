<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NewsPulse — Financial News & Momentum</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121826; --border:#20273a; --text:#e6e8ee; --muted:#9aa3b2;
      --accent:#b167ff; --accent-2:#8f6cff; --up:#24e39c; --down:#ff5b6e;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:1200px; margin:0 auto; padding:20px; }

    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .brand{ font-weight:900; letter-spacing:.2px; }
    .rightTop{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:flex-end }
    .clock{ color:var(--muted); font-size:.95rem }
    .session{ border:1px solid var(--border); padding:4px 8px; border-radius:999px; color:var(--muted); font-size:.8rem }
    .session.live{ color:var(--text); border-color:var(--accent) }

    .donateCta{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:.9rem }
    .donateCta strong{ color:#fff }
    .donateBar{ display:flex; gap:8px; flex-wrap:wrap; }
    .donateBar button{
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#fff; border:1px solid rgba(255,255,255,.12);
      padding:8px 12px; border-radius:999px; font-weight:800; cursor:pointer; font-size:.9rem;
    }

    .disclaimer{
      background:linear-gradient(180deg, rgba(177,103,255,.15), rgba(177,103,255,.06));
      border:1px solid var(--border);
      color:var(--text);
      padding:14px 16px; border-radius:12px; margin-bottom:18px; line-height:1.5;
    }
    .disclaimer strong{ color:var(--accent); }

    .tabs{ display:flex; gap:10px; margin:12px 0 18px }
    .tab{ border:1px solid var(--border); background:var(--card); color:var(--text); padding:10px 16px; border-radius:999px; cursor:pointer; }
    .tab.active{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(177,103,255,.15) inset }

    .panel{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }

    /* Compact Filters dropdown */
    .filters { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
    .filter-btn {
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#fff; border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700;
    }
    .input-ctl{
      background:var(--card); color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:10px; outline:none;
    }
    .dropdown { position:relative; }
    .dropdown-menu{
      position:absolute; top:110%; left:0; min-width:260px; z-index:50;
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:10px; display:none; box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .dropdown[data-open="true"] .dropdown-menu{ display:block; }
    .dropdown-menu h4{ margin:6px 6px 8px; font-size:.9rem; color:#e6e8ee }
    .dropdown-menu .row{ display:flex; flex-wrap:wrap; gap:8px; padding:0 6px 8px; }
    .dropdown-chip{
      display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#0b0f17; color:#e6e8ee; font-size:.85rem;
    }
    .dropdown-actions{ display:flex; gap:8px; justify-content:flex-end; padding:6px; }
    .dropdown-actions button{
      background:#2a3350; color:#e6e8ee; border:1px solid #394368; border-radius:8px; padding:6px 10px; cursor:pointer;
    }

    /* News list */
    .news-list{ display:grid; gap:12px; }
    .news-item{ border:1px solid var(--border); border-radius:12px; padding:12px; background:linear-gradient(180deg, rgba(32,39,58,.6), rgba(18,24,38,.9)); }
    .item-top{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .ticker{ background:rgba(177,103,255,.16); border:1px solid var(--accent); color:#fff; padding:4px 10px; border-radius:999px; font-weight:700; cursor:pointer; text-decoration:none }
    .pct{ font-weight:700 } .pct.up{ color:var(--up) } .pct.down{ color:var(--down) }
    .meta{ color:var(--muted); font-size:.85rem } .title{ margin-top:8px; font-weight:800; color:#fff }
    .summary{ color:var(--muted); margin-top:6px; line-height:1.5 }
    .mini-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:8px }

    /* Mini chart size (larger + readable) */
    .mini-chart{ width:220px; height:60px }
    @media (max-width:700px){ .mini-chart{ width:100%; height:60px } }

    .loading{ text-align:center; color:var(--muted); padding:28px }

    /* Modal */
    #chartModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:9999; background:rgba(0,0,0,.55); padding:20px }
    .modal{ width:min(920px,95vw); height:min(600px,85vh); background:var(--card); border:1px solid var(--border); border-radius:14px; display:flex; flex-direction:column; }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border) }
    .modal-title{ font-weight:900 }
    .modal-tools{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .modal label{ color:var(--muted); font-size:.9rem }
    .close{ background:none; border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:8px; cursor:pointer }
    .modal-body{ flex:1 }

    /* Scanner */
    .filters .pill{ background:#1a2132; border:1px solid var(--border); color:#e6e8ee; border-radius:999px; padding:8px 10px; font-size:.9rem }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px }
    .kpi{ display:flex; align-items:center; justify-content:space-between; gap:10px }
    .change.up{ color:var(--up); font-weight:800 } .change.down{ color:var(--down); font-weight:800 }

    @media (max-width:900px){
      .rightTop{ justify-content:flex-start }
    }
    @media (max-width:700px){
      .donateCta{ display:none } /* keep it clean on small screens */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">NewsPulse</div>
      <div class="rightTop">
        <div class="donateCta">Please consider <strong>donating</strong> so we can add paid data & grow this into a full app.</div>
        <div class="donateBar">
          <button id="donate-once">Donate Once</button>
          <button id="donate-monthly">Donate Monthly</button>
          <button id="manage-subscription">Manage Subscription</button>
        </div>
        <div class="clock" id="etClock">—:— ET</div>
        <div class="session" id="sessionBadge">Session: —</div>
      </div>
    </div>

    <div class="disclaimer">
      <strong>Educational Purposes Only.</strong> The content on this site (including news, data, and any analysis) is provided for informational and educational purposes only and does not constitute investment, financial, or trading advice. Nothing on this website is a recommendation or endorsement to buy or sell any security. Market data may be delayed, inaccurate, or incomplete. Trading involves substantial risk, including the risk of loss. You are solely responsible for your trading decisions. Consider consulting a licensed financial professional. We make no warranties and assume no liability for any losses arising from use of this site.
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="news">News</button>
      <button class="tab" data-tab="scanners">Scanners</button>
    </div>

    <!-- NEWS VIEW -->
    <div id="view-news" class="panel">
      <div class="filters">
        <!-- Compact multi-select dropdown -->
        <div class="dropdown" id="catDropdown">
          <button class="filter-btn" id="openFilters">Filters ▾</button>
          <div class="dropdown-menu" id="filtersMenu">
            <h4>Categories</h4>
            <div class="row">
              <label class="dropdown-chip"><input type="checkbox" value="medical" /> Medical/FDA</label>
              <label class="dropdown-chip"><input type="checkbox" value="patent" /> Patent</label>
              <label class="dropdown-chip"><input type="checkbox" value="lawsuit" /> Lawsuit</label>
              <label class="dropdown-chip"><input type="checkbox" value="acquisition" /> M&amp;A</label>
              <label class="dropdown-chip"><input type="checkbox" value="earnings" /> Earnings</label>
              <label class="dropdown-chip"><input type="checkbox" value="offering" /> Public Offering</label>
              <label class="dropdown-chip"><input type="checkbox" value="guidance" /> Guidance</label>
              <label class="dropdown-chip"><input type="checkbox" value="upgrade" /> Upgrade</label>
              <label class="dropdown-chip"><input type="checkbox" value="downgrade" /> Downgrade</label>
              <label class="dropdown-chip"><input type="checkbox" value="partnership" /> Partnership</label>
              <label class="dropdown-chip"><input type="checkbox" value="product" /> Product</label>
              <label class="dropdown-chip"><input type="checkbox" value="sec" /> SEC Filing</label>
              <label class="dropdown-chip"><input type="checkbox" value="insider" /> Insider</label>
            </div>
            <div class="dropdown-actions">
              <button id="applyFilters">Apply</button>
              <button id="clearFilters">Clear</button>
              <button id="closeFilters">Close</button>
            </div>
          </div>
        </div>

        <!-- Ticker & keyword -->
        <input id="ticker" class="input-ctl" placeholder="Ticker (optional)" />
        <input id="keyword" class="input-ctl" placeholder="Keyword (optional)" />

        <!-- Actions -->
        <button class="filter-btn" id="run">Refresh Now</button>
      </div>

      <div id="news-feed" class="news-list">
        <div class="loading"><span>Loading financial news…</span></div>
      </div>
    </div>

    <!-- SCANNERS VIEW -->
    <div id="view-scanners" class="panel" style="display:none">
      <div class="filters">
        <span class="pill">High Momentum</span>
        <span class="pill">Top % Gainers</span>
        <span class="pill">High RVOL</span>
        <input id="minPct" class="input-ctl" type="number" step="0.1" placeholder="Min % (e.g. 2)" />
        <input id="minRVOL" class="input-ctl" type="number" step="0.1" placeholder="Min RVOL (e.g. 1.5)" />
        <input id="minMentions" class="input-ctl" type="number" step="1" placeholder="Min news mentions" />
        <button class="filter-btn" id="rescore">Recalculate</button>
      </div>
      <div id="scanner-grid" class="grid">
        <div class="card">Run a news load, then click Recalculate to see high-momentum movers.</div>
      </div>
    </div>
  </div>

  <!-- CHART MODAL -->
  <div id="chartModal">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="chartTitle">Chart</div>
        <div class="modal-tools">
          <label>Indicators:</label>
          <label><input type="checkbox" class="ind" value="vwap" checked /> VWAP</label>
          <label><input type="checkbox" class="ind" value="sma20" /> SMA 20</label>
          <label><input type="checkbox" class="ind" value="ema9" /> EMA 9</label>
          <label><input type="checkbox" class="ind" value="rsi14" /> RSI 14</label>
          <button class="close" onclick="closeChart()">Close</button>
        </div>
      </div>
      <div id="chartBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    // ---------- STATE ----------
    const RETAIN_DAYS = 7;
    let allNewsStore = new Map();    // id -> article (persisted)
    let newsData = [];               // derived (sorted)
    let filteredNews = [];
    const stockCache = new Map();    // ticker -> { changePercent, change, ts }
    const selectedCategories = new Set();
    const etFmt = new Intl.DateTimeFormat('en-US',{ timeZone:'America/New_York', hour:'2-digit', minute:'2-digit' });

    // load persisted store
    (function loadStore(){
      try {
        const raw = localStorage.getItem('newsStoreV1');
        const keptUntil = Date.now() - RETAIN_DAYS*24*3600*1000;
        if (raw) {
          const arr = JSON.parse(raw);
          for (const a of arr) {
            const t = Date.parse(a.publishedAt||0);
            if (!t || t < keptUntil) continue;
            allNewsStore.set(a.id, a);
          }
        }
      } catch {}
    })();

    function persistStore(){
      try {
        const arr = Array.from(allNewsStore.values());
        localStorage.setItem('newsStoreV1', JSON.stringify(arr));
      } catch {}
    }

    function mergeNews(newItems){
      let added=0;
      for(const a of (newItems||[])){
        if(!a || !a.id) continue;
        if(!allNewsStore.has(a.id)){ allNewsStore.set(a.id, a); added++; }
        else allNewsStore.set(a.id, { ...allNewsStore.get(a.id), ...a });
      }
      if (added) persistStore();
      return added;
    }

    function currentNewsArray(){
      const arr = Array.from(allNewsStore.values());
      arr.sort((a,b)=> (Date.parse(b.publishedAt||0) - Date.parse(a.publishedAt||0)));
      return arr;
    }

    // ---------- CLOCK + SESSION ----------
    function updateClockAndSession(){
      const now = new Date();
      document.getElementById('etClock').textContent = etFmt.format(now) + ' ET';
      const d = new Date().toLocaleString('en-US', { timeZone: 'America/New_York' });
      const n = new Date(d); const day=n.getDay(); const hh=n.getHours(), mm=n.getMinutes(); const mins=hh*60+mm;
      let label='Closed', live=false;
      if(day>=1 && day<=5){
        if(mins<570 && mins>=240) label='Premarket';
        else if(mins>=570 && mins<=960){ label='Regular Hours'; live=true; }
        else if(mins>960 && mins<=1200) label='After-hours';
      }
      const b=document.getElementById('sessionBadge'); b.textContent=`Session: ${label}`; b.className='session'+(live?' live':'');
    }
    setInterval(updateClockAndSession, 15000); updateClockAndSession();

    // ---------- HELPERS ----------
    function timeAgo(iso){
      const t = Date.parse(iso||''); if(!t) return '';
      const s = Math.floor((Date.now()-t)/1000);
      if (s<60) return `${s}s ago`;
      const m = Math.floor(s/60); if(m<60) return `${m}m ago`;
      const h = Math.floor(m/60); if(h<24) return `${h}h ago`;
      const d = Math.floor(h/24); return `${d}d ago`;
    }

    async function getQuote(ticker){
      const key = ticker.toUpperCase();
      const cached = stockCache.get(key);
      if(cached && (Date.now()-cached.ts)<60_000) return cached;
      const r = await fetch(`/api/data?ticker=${encodeURIComponent(key)}`);
      if(!r.ok) return null;
      const payload = await r.json();
      const q = payload?.data?.stock;
      if(!q) return null;
      const obj = { changePercent:q.changePercent, change:q.change, ts:Date.now() };
      stockCache.set(key, obj); return obj;
    }

    async function getRVOL(ticker){
      const r = await fetch(`/api/data?ticker=${encodeURIComponent(ticker)}`);
      if(!r.ok) return null;
      const payload = await r.json();
      const m = payload?.data?.market;
      if(!m || !m.volume || !m.avgVolume) return null;
      return m.volume / m.avgVolume;
    }

    async function drawSparkline(el, ticker){
      try{
        const r = await fetch(`/api/ohlc?ticker=${encodeURIComponent(ticker)}&interval=1min&limit=120&last=1`);
        const payload = await r.json();
        const candles = payload.candles||[];
        const closes = candles.map(c=>c.c);
        if(closes.length<2){ el.innerHTML=''; return; }
        const w=220,h=60,pad=5;
        const min=Math.min(...closes), max=Math.max(...closes);
        const xStep=(w-2*pad)/(closes.length-1);
        const y=v=> h-pad-((v-min)/(max-min||1))*(h-2*pad);
        let d=''; closes.forEach((v,i)=>{ const x=pad+i*xStep; const yy=y(v); d+=(i?`L${x},${yy}`:`M${x},${yy}`); });
        const color = closes[closes.length-1]>=closes[0] ? '#24e39c' : '#ff5b6e';
        el.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
          <path d="${d}" fill="none" stroke="${color}" stroke-width="2"/></svg>`;
      }catch{ el.innerHTML=''; }
    }

    // ---------- FETCH ----------
    async function fetchData(){
      const params = new URLSearchParams();
      const t = (document.getElementById('ticker').value||'').trim();
      const k = (document.getElementById('keyword').value||'').trim();
      if (t) params.set('ticker', t.toUpperCase());
      if (k) params.set('search', k);

      try{
        const r = await fetch(`/api/data?${params.toString()}`);
        if(!r.ok) throw new Error('API error');
        const data = await r.json();
        const incoming = data?.data?.news || [];
        mergeNews(incoming);
        newsData = currentNewsArray();
        applyFilter();
      }catch(e){
        console.error(e);
        newsData = currentNewsArray();
        applyFilter();
      }
    }

    // ---------- FILTERS ----------
    function applyFilter(){
      const k = (document.getElementById('keyword').value||'').toLowerCase();
      const cats = selectedCategories;

      filteredNews = newsData.filter(n=>{
        const byCat = (!cats.size) ? true : (
          cats.has(n.category) ||
          [...cats].some(c=> (n.title||'').toLowerCase().includes(c) || (n.summary||'').toLowerCase().includes(c))
        );
        const byKey = !k || ( (n.title||'').toLowerCase().includes(k) || (n.summary||'').toLowerCase().includes(k) );
        return byCat && byKey;
      });
      renderNews();
    }

    // ---------- RENDER NEWS ----------
    function renderNews(){
      const feed = document.getElementById('news-feed');
      if (!filteredNews.length){
        feed.innerHTML = `<div class="loading">No news found for the selected filter.</div>`;
        return;
      }
      feed.innerHTML = filteredNews.map(n=>{
        const t = (n.ticker||'').toUpperCase();
        const when = n.publishedAt ? timeAgo(n.publishedAt) : '';
        const source = n.source ? n.source : '';
        return `
          <div class="news-item">
            <div class="item-top">
              <a class="ticker" href="#" data-open-chart="${t}">${t || 'GENERAL'}</a>
              <span class="pct"><span class="arrow">⏳</span><span class="val">…</span></span>
              <span class="meta rvol"></span>
              <span class="meta">${source ? source : ''}${when ? ` · ${when}` : ''}</span>
            </div>
            <div class="title">${n.title||''}</div>
            <div class="summary">${n.summary||''} ${n.url?`<a href="${n.url}" target="_blank" rel="noopener">Read</a>`:''}</div>
            <div class="mini-row">
              <div class="meta">${n.category ? n.category : ''}</div>
              <div class="mini-chart" data-ticker="${t}"></div>
            </div>
          </div>
        `;
      }).join('');

      // lazy-render sparklines + fetch pct change/RVOL
      const cards = feed.querySelectorAll('.news-item');
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(async e=>{
          if(!e.isIntersecting) return;
          const card = e.target;
          const slot = card.querySelector('.mini-chart');
          const t = slot?.getAttribute('data-ticker');
          if (t && t !== 'GENERAL') {
            // % change
            try{
              const q = await getQuote(t);
              if(q && typeof q.changePercent==='number'){
                const val = card.querySelector('.val');
                const arrow = card.querySelector('.arrow');
                val.textContent = `${q.changePercent>0?'+':''}${q.changePercent.toFixed(2)}%`;
                val.className = 'val ' + (q.changePercent>0?'up':'down');
                arrow.textContent = q.changePercent>0 ? '↗' : '↘';
              }
            }catch{}
            // RVOL
            try{
              const rv = await getRVOL(t);
              if (rv) card.querySelector('.rvol').textContent = `RVOL ${rv.toFixed(2)}x`;
            }catch{}
            // sparkline
            drawSparkline(slot, t);
          }
          io.unobserve(card);
        });
      }, { root:null, rootMargin:'200px', threshold:.01 });
      cards.forEach(c=>io.observe(c));
    }

    // ---------- SCANNER ----------
    async function buildScanners(){
      const base = filteredNews.length ? filteredNews : newsData;
      const stats = new Map(); // ticker -> {mentions, latest}
      for(const n of base){
        const t = (n.ticker||'').toUpperCase(); if(!t || t==='GENERAL') continue;
        const s = stats.get(t)||{mentions:0,latest:0}; s.mentions++;
        const ts = n.publishedAt?Date.parse(n.publishedAt):0; if(ts> (s.latest||0)) s.latest = ts;
        stats.set(t,s);
      }
      const list = [...stats.keys()].slice(0,50);
      const rows = [];
      for(const t of list){
        let pct=0, rvol=0, rec=0;
        try{ const q=await getQuote(t); pct = q?.changePercent||0; }catch{}
        try{ const rv=await getRVOL(t); rvol = rv||0; }catch{}
        const minsOld = stats.get(t)?.latest ? (Date.now()-stats.get(t).latest)/60000 : 999;
        rec = Math.max(0, 30 - Math.min(30, minsOld)); // 0..30
        const score = (pct*1.0) + (stats.get(t).mentions*0.6) + (rvol*5) + (rec*0.35);
        rows.push({ ticker:t, pct, mentions:stats.get(t).mentions, rvol, recency:rec, score });
      }
      rows.sort((a,b)=> b.score-a.score);
      const minPct = parseFloat(document.getElementById('minPct').value||'NaN');
      const minRVOL = parseFloat(document.getElementById('minRVOL').value||'NaN');
      const minMent = parseFloat(document.getElementById('minMentions').value||'NaN');
      const filt = rows.filter(r=>{
        return (isNaN(minPct) || r.pct>=minPct) &&
               (isNaN(minRVOL) || r.rvol>=minRVOL) &&
               (isNaN(minMent) || r.mentions>=minMent);
      }).slice(0,12);

      const grid = document.getElementById('scanner-grid');
      if(!filt.length){ grid.innerHTML = `<div class="card">No results match the thresholds.</div>`; return; }
      grid.innerHTML = filt.map(r=>`
        <div class="card">
          <div class="kpi">
            <div>
              <div style="font-weight:900">${r.ticker}</div>
              <div class="meta">Mentions: ${r.mentions} · RVOL: ${r.rvol?r.rvol.toFixed(2):'—'} · Recency: ${r.recency.toFixed(0)}</div>
            </div>
            <div class="change ${r.pct>0?'up':'down'}">${r.pct>0?'↗':'↘'} ${r.pct.toFixed(2)}%</div>
          </div>
          <div class="meta" style="margin-top:6px">
            Score: ${r.score.toFixed(1)} · <a href="#" data-open-chart="${r.ticker}">Chart</a>
          </div>
          <div class="mini-chart" data-ticker="${r.ticker}" style="margin-top:8px"></div>
        </div>
      `).join('');

      // Draw mini charts for each scanner card (today or last session)
      grid.querySelectorAll('.mini-chart').forEach(slot=>{
        const t = slot.getAttribute('data-ticker');
        if (t) drawSparkline(slot, t);
      });
    }

    // ---------- CHART MODAL ----------
    function sma(data, period){
      const out=[]; let sum=0;
      for(let i=0;i<data.length;i++){ sum+=data[i].close; if(i>=period) sum-=data[i-period].close; if(i>=period-1) out.push({time:data[i].time,value:sum/period}); }
      return out;
    }
    function ema(data, period){
      const out=[]; const k=2/(period+1); let prev=data[0]?.close||0;
      out.push({time:data[0]?.time,value:prev});
      for(let i=1;i<data.length;i++){ const v=data[i].close*k + prev*(1-k); out.push({time:data[i].time,value:v}); prev=v; }
      return out;
    }
    function rsi(data, period){
      const out=[]; let g=0,l=0;
      for(let i=1;i<=period;i++){ const ch=data[i].close - data[i-1].close; if(ch>=0) g+=ch; else l-=ch; }
      let avgG=g/period, avgL=l/period; let rs=avgL===0?100:avgG/avgL;
      out.push({time:data[period].time,value:100-100/(1+rs)});
      for(let i=period+1;i<data.length;i++){
        const ch=data[i].close - data[i-1].close; const gg=Math.max(0,ch), ll=Math.max(0,-ch);
        avgG=(avgG*(period-1)+gg)/period; avgL=(avgL*(period-1)+ll)/period; rs=avgL===0?100:avgG/avgL;
        out.push({time:data[i].time,value:100-100/(1+rs)});
      }
      return out;
    }
    function getIndPrefs(){ try { return JSON.parse(localStorage.getItem('indPrefsV1')||'{}'); } catch { return {}; } }
    function setIndPrefs(obj){ try { localStorage.setItem('indPrefsV1', JSON.stringify(obj||{})); } catch {} }

    async function openChart(ticker){
      const modal = document.getElementById('chartModal');
      const body = document.getElementById('chartBody');
      const title = document.getElementById('chartTitle');
      title.textContent = `${ticker} — intraday (1m)`;
      body.innerHTML = '';

      const r = await fetch(`/api/ohlc?ticker=${encodeURIComponent(ticker)}&interval=1min&limit=300&last=1`);
      const payload = await r.json();
      const candles = payload.candles||[];
      const data = candles.map(k=>({ time:Math.floor(new Date(k.t).getTime()/1000), open:k.o, high:k.h, low:k.l, close:k.c, volume:k.v }));

      const container = document.createElement('div'); container.style.width='100%'; container.style.height='100%'; body.appendChild(container);
      const chart = LightweightCharts.createChart(container, {
        layout:{ background:{type:'Solid', color:'#0b0f17'}, textColor:'#e6e8ee' },
        grid:{ vertLines:{color:'#1a2132'}, horzLines:{color:'#1a2132'} },
        rightPriceScale:{ borderColor:'#20273a' }, timeScale:{ borderColor:'#20273a' }, autoSize:true
      });

      const candleSeries = chart.addCandlestickSeries({
        upColor:'#24e39c', downColor:'#ff5b6e', borderUpColor:'#24e39c', borderDownColor:'#ff5b6e', wickUpColor:'#24e39c', wickDownColor:'#ff5b6e'
      });
      candleSeries.setData(data);

      const volSeries = chart.addHistogramSeries({ priceFormat:{type:'volume'}, priceScaleId:'', base:0 });
      volSeries.setData(data.map(k=>({ time:k.time, value:k.volume, color: k.close>=k.open?'#24e39c':'#ff5b6e' })));
      chart.priceScale('').applyOptions({ scaleMargins:{ top:0.8, bottom:0 } });

      // Indicators (checkboxes)
      let vwap=null,sma20=null,ema9=null,rsiPane=null;
      const checks = Array.from(document.querySelectorAll('.modal .ind'));
      const pref = getIndPrefs();
      checks.forEach(ch => ch.checked = pref[ch.value] ?? ch.checked);

      function renderIndicators(){
        const chosen = new Set(checks.filter(c=>c.checked).map(c=>c.value));
        setIndPrefs(Object.fromEntries([...chosen].map(k=>[k,true])));

        // VWAP
        if(chosen.has('vwap')){
          if(!vwap) vwap = chart.addLineSeries({ color:'#b167ff', lineWidth:2 });
          let cumPV=0,cumV=0;
          const v = data.map(k=>{ const typ=(k.high+k.low+k.close)/3; const vv=(k.volume||0)||1; cumPV+=typ*vv; cumV+=vv; return {time:k.time,value:cumPV/cumV}; });
          vwap.setData(v);
        } else if(vwap){ vwap.setData([]); }

        // SMA20
        if(chosen.has('sma20')){ if(!sma20) sma20=chart.addLineSeries({color:'#8f6cff',lineWidth:2}); sma20.setData(sma(data,20)); }
        else if(sma20){ sma20.setData([]); }

        // EMA9
        if(chosen.has('ema9')){ if(!ema9) ema9=chart.addLineSeries({color:'#c08bff',lineWidth:2}); ema9.setData(ema(data,9)); }
        else if(ema9){ ema9.setData([]); }

        // RSI
        if(chosen.has('rsi14')){
          if(!rsiPane){ rsiPane=chart.addLineSeries({ color:'#b167ff', lineWidth:2, priceScaleId:'rsi' }); chart.priceScale('rsi').applyOptions({ scaleMargins:{ top:0.02, bottom:0.65 } }); }
          rsiPane.setData(rsi(data,14));
        } else if(rsiPane){ rsiPane.setData([]); }
      }
      checks.forEach(ch => ch.addEventListener('change', renderIndicators));
      renderIndicators();

      try{ const q=await getQuote(ticker); if(q && typeof q.changePercent==='number'){ title.textContent += ` • ${q.changePercent>0?'↗':'↘'} ${q.changePercent.toFixed(2)}%`; } }catch{}
      modal.style.display='flex';
    }
    function closeChart(){ document.getElementById('chartModal').style.display='none'; }

    // ---------- STRIPE (front-end calls to your private API) ----------
    async function postJSON(url, body){
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }
    document.getElementById('donate-once').addEventListener('click', async ()=>{
      try{ const { url } = await postJSON('/api/checkout', { mode:'payment' }); if(url) window.location.href = url; }catch(e){ alert('Unable to start checkout.'); }
    });
    document.getElementById('donate-monthly').addEventListener('click', async ()=>{
      try{ const { url } = await postJSON('/api/checkout', { mode:'subscription' }); if(url) window.location.href = url; }catch(e){ alert('Unable to start checkout.'); }
    });
    document.getElementById('manage-subscription').addEventListener('click', async ()=>{
      try{ const { url } = await postJSON('/api/portal', {}); if(url) window.location.href = url; }catch(e){ alert('Unable to open portal.'); }
    });

    // ---------- UI EVENTS ----------
    document.addEventListener('click', (e)=>{
      const tab = e.target.closest('.tab');
      if(tab){
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        tab.classList.add('active');
        const v = tab.dataset.tab;
        document.getElementById('view-news').style.display = (v==='news')?'block':'none';
        document.getElementById('view-scanners').style.display = (v==='scanners')?'block':'none';
      }
      const chartLink = e.target.closest('[data-open-chart]');
      if(chartLink){ e.preventDefault(); const t = chartLink.getAttribute('data-open-chart'); if(t && t!=='GENERAL') openChart(t); }
    });

    // Dropdown wiring
    const catDrop = document.getElementById('catDropdown');
    const openFiltersBtn = document.getElementById('openFilters');
    const closeFiltersBtn = document.getElementById('closeFilters');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const filtersMenu = document.getElementById('filtersMenu');

    openFiltersBtn.addEventListener('click', (e)=> {
      e.stopPropagation();
      catDrop.setAttribute('data-open','true');
    });
    closeFiltersBtn.addEventListener('click', (e)=> {
      e.stopPropagation();
      catDrop.removeAttribute('data-open');
    });
    document.addEventListener('click', (e)=>{
      if (!catDrop.contains(e.target)) catDrop.removeAttribute('data-open');
    });

    applyFiltersBtn.addEventListener('click', ()=>{
      selectedCategories.clear();
      filtersMenu.querySelectorAll('input[type="checkbox"][value]').forEach(cb=>{
        if (cb.checked) selectedCategories.add(cb.value);
      });
      catDrop.removeAttribute('data-open');
      applyFilter();
    });
    clearFiltersBtn.addEventListener('click', ()=>{
      filtersMenu.querySelectorAll('input[type="checkbox"][value]').forEach(cb=> cb.checked = false);
      selectedCategories.clear();
      applyFilter();
    });

    document.getElementById('run').addEventListener('click', ()=>fetchData());
    document.getElementById('rescore').addEventListener('click', buildScanners);

    // ---------- INIT ----------
    async function init(){
      document.getElementById('news-feed').innerHTML = `<div class="loading">Fetching live financial news…</div>`;
      await fetchData();
      setInterval(()=>fetchData(), 60000); // keep merging, never wipe on empty
    }
    init();
  </script>
</body>
</html>
